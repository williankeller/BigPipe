/*
 * BIGPIPE 
 * Desenvolvimento Willian Keller
 * Y - 2015
 * Bigpipe is facebook
 */

g=function(e){if(window.execScript)return void window.execScript(e);var s=function(){window.eval.call(window,e)};s()},PageletResource=Class.create({name:null,file:null,type:null,phase:0,belongs:null,initialize:function(e,s,t){this.type=t,this.name=s,this.file=e,this.belongs=new Array,BigPipe.debug("Pagelet "+s+" criado tipo "+t+" com arquivo ",e)},attachToPagelet:function(e){this.belongs.push(e)},startLoading:function(){if(0==this.phase){if(BigPipe.debug("Carregamento iniciado "+this.type+" recurso:",this.file),"css"==this.type){var e=document.createElement("link");e.setAttribute("rel","stylesheet"),e.setAttribute("type","text/css"),e.setAttribute("href",this.file),$$("head").first().insert(e),this.phase=1,this.onComplete()}if("js"==this.type){var s=document.createElement("script");s.setAttribute("type","text/javascript"),s.setAttribute("src",this.file),document.body.appendChild(s)}}},onComplete:function(){2!=this.phase&&(this.phase=2,this.belongs.each(function(e){e(this)}.bind(this)))}}),Pagelet=Class.create({jsCode:null,cssResources:null,jsResources:null,id:"",content:"",json:null,phase:0,initialize:function(e){this.id=e.id,this.phase=0,this.json=e,this.jsCode=e.script,this.cssResources=new Hash,this.jsResources=new Hash,this.innerHTML=e.content},start:function(){this.json.css.each(function(e){var s=BigPipe.pageletResourceFactory(e,"css");this.attachCssResource(s)}.bind(this)),this.json.js.each(function(e){var s=BigPipe.pageletResourceFactory(e,"js");this.attachJsResource(s)}.bind(this)),this.cssResources.each(function(e){this.phase=1,e.value.startLoading()}),0==this.phase&&this.injectInnerHTML()},attachCssResource:function(e){BigPipe.debug("Anexando recurso CSS "+e.file+" ao pagelet "+this.id,null),e.attachToPagelet(this.onCssOnload.bind(this)),this.cssResources.set(e.file,e)},attachJsResource:function(e){BigPipe.debug("Anexando recurso JS "+e.file+" ao pagelet "+this.id,null),e.attachToPagelet(this.onJsOnload.bind(this)),this.jsResources.set(e.file,e)},onJsOnload:function(e){if(!(this.phase>3)){var s=!0;if(this.jsResources.each(function(e){2!=e.value.phase&&(s=!1)}),s){if(this.jsResources.size()>0&&BigPipe.debug("Pagelet "+this.id+": Todos os recursos JS estão carregados."),this.jsCode&&""!=this.jsCode)try{BigPipe.debug("Executando código js: ",this.jsCode),g(this.jsCode),BigPipe.debug("Código js executado: ",this.jsCode)}catch(t){BigPipe.debug("Erro ao executar "+e,t)}this.phase=4}}},onCssOnload:function(e){BigPipe.debug("pagelet "+this.id+" foi notificado que o recurso CSS carregado é: ",e);var s=!0;this.cssResources.each(function(e){2!=e.value.phase&&(s=!1)}),s&&(BigPipe.debug("todos os recursos carregados",this),this.injectInnerHTML())},injectInnerHTML:function(){this.phase=2;var e=$(this.id);BigPipe.debug("inserindo conteúdo emavaliando código js "+this.id,this),null!=e&&"string"==typeof this.innerHTML&&""!=this.innerHTML&&e.update(this.innerHTML),this.phase=3,BigPipe.pageletHTMLInjected(this)}}),BigPipe={pageletResources:new Hash,pagelets:new Hash,phase:0,debug_:!0,onArrive:function(e){this.debug("Pagelet disponível: ",e),void 0!=e.is_last&&e.is_last&&(this.debug("Este pagelet é o último:",e),this.phase=1);var s=new Pagelet(e);this.pagelets.set(s.id,s),s.start()},fileLoaded:function(e){var s=this.pageletResources.get(e);BigPipe.debug("Arquivo JS carregado:",e),s&&s.onComplete()},pageletHTMLInjected:function(e){var s=!0;this.debug("pageletHTMLInjected",e),this.pagelets.each(function(e){e.value.phase<3&&(this.debug("pageletHTMLInjected pagelet ainda não carregado",e.value),s=!1)}.bind(this)),s&&1==this.phase&&this.loadJSResources()},loadJSResources:function(){this.phase=2,this.debug("Começando carregar os recursos JS...");var e=!1;this.pageletResources.each(function(s){"js"==s.value.type&&(e=!0,s.value.startLoading())}),this.pagelets.each(function(e){0==e.value.jsResources.size()&&e.value.onJsOnload()}.bind(this)),e||(this.debug("Sem recursos js em página, avançar..."),this.pagelets.each(function(e){e.value.onJsOnload()}.bind(this)))},debug:function(e,s){BigPipe.debug_&&"undefined"!=typeof console&&"undefined"!=typeof console.log&&console.log("BigPipe."+e,s)},pageletResourceFactory:function(e,s){var t=new RegExp("(?:.*/)?(.+js)"),i=t.exec(e),a=e;i&&(a=i[1]);var n=this.pageletResources.get(a);return null==n&&(n=new PageletResource(e,a,s),this.pageletResources.set(a,n)),n}};